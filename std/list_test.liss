(import "test_utils" ["benchmark"])
(import "list")
(import "assert")

(fn _mk_rand_vec [size]
    (fn _next [ix acc]
        (cond (>= ix size)
            acc
            (
                (let _acc (+ acc [(randn 100)]))
                (_next (+ ix 1) _acc)
            )
        )
    )
    (_next 0 [])
)

(fn _is_sorted [arr]
    (fn _next [ix]
        (cond (>= ix (len arr))
            true
            (cond (<= (get arr (- ix 1)) (get arr ix))
                (_next (+ ix 1))
                false
            )
        )
    )
    (cond (or (is_null? arr) (<= (len arr) 1))
        true
        (_next 1)
    )
)

((fn test_list_push []
    (let tests [
        (dict ["name" "null list"] ["input" null] ["want" null])
        (dict ["name" "empty list"] ["input" []] ["want" [1]])
        (dict ["name" "non-empty list"] ["input" [2 3 4] ] ["want" [2 3 4 1]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (list:push input 1))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn test_list_reduce []
    (let tests [
        (dict ["name" "sum of null"] ["input" null] ["want" null])
        (dict ["name" "sum of empty list"] ["input" []] ["want" 0])
        (dict ["name" "sum of single element"] ["input" [5]] ["want" 5])
        (dict ["name" "sum of multiple elements"] ["input" [1 2 3 4]] ["want" 10])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (list:reduce input (fn [acc x] (+ acc x)) 0))
        (assert:equal got want)
        (println ": OK")
    ))
))

((fn test_list_map []
    (let tests [
        (dict ["name" "map null"] ["input" null] ["want" null])
        (dict ["name" "map empty list"] ["input" []] ["want" []])
        (dict ["name" "map single element"] ["input" [2]] ["want" [4]])
        (dict ["name" "map multiple elements"] ["input" [1 2 3 4]] ["want" [2 4 6 8]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (list:map input (fn [x] (* x 2))))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn test_list_filter []
    (let tests [
        (dict ["name" "filter null"] ["input" null] ["want" null])
        (dict ["name" "filter empty list"] ["input" []] ["want" []])
        (dict ["name" "filter single element (true)"] ["input" [2]] ["want" [2]])
        (dict ["name" "filter single element (false)"] ["input" [3]] ["want" []])
        (dict ["name" "filter multiple elements"] ["input" [1 2 3 4 5 6]] ["want" [2 4 6]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (list:filter input (fn [x] (= (% x 2) 0))))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn test_list_range []
    (let tests [
        (dict ["name" "range null"] ["input" null] ["start" 0] ["end" 2] ["want" null])
        (dict ["name" "range empty list"] ["input" []] ["start" 0] ["end" 2] ["want" []])
        (dict ["name" "range single element"] ["input" [1]] ["start" 0] ["end" 1] ["want" [1]])
        (dict ["name" "range multiple elements"] ["input" [1 2 3 4 5]] ["start" 1] ["end" 4] ["want" [2 3 4]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let start (get test "start"))
        (let end (get test "end"))
        (let want (get test "want"))
        (let got (list:range input start end))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn test_list_reverse []
    (let tests [
        (dict ["name" "reverse null"] ["input" null] ["want" null])
        (dict ["name" "reverse empty list"] ["input" []] ["want" []])
        (dict ["name" "reverse single element"] ["input" [1]] ["want" [1]])
        (dict ["name" "reverse multiple elements"] ["input" [1 2 3 4]] ["want" [4 3 2 1]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (list:reverse input))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn test_list_find []
    (let tests [
        (dict ["name" "find in null"] ["input" [null 1]] ["want" null])
        (dict ["name" "find in empty list"] ["input" [[] 1]] ["want" -1])
        (dict ["name" "find existing element"] ["input" [[1 2 3 4] 3]] ["want" 2])
        (dict ["name" "find non-existing element"] ["input" [[1 2 3 4] 5]] ["want" -1])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let arr (get (get test "input") 0))
        (let n (get (get test "input") 1))
        (let want (get test "want"))
        (let got (list:find arr n))
        (assert:equal got want)
        (println ": OK")
    ))
))

((fn test_list_contains []
    (let tests [
        (dict ["name" "contains in null"] ["input" [null 1]] ["want" false])
        (dict ["name" "contains in empty list"] ["input" [[] 1]] ["want" false])
        (dict ["name" "contains existing element"] ["input" [[1 2 3 4] 3]] ["want" true])
        (dict ["name" "contains non-existing element"] ["input" [[1 2 3 4] 5]] ["want" false])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let arr (get (get test "input") 0))
        (let n (get (get test "input") 1))
        (let want (get test "want"))
        (let got (list:contains? arr n))
        (assert:equal got want)
        (println ": OK")
    ))
))

((fn test_list_find_all []
    (let tests [
        (dict ["name" "find_all in null"] ["input" [null 1]] ["want" null])
        (dict ["name" "find_all in empty list"] ["input" [[] 1]] ["want" []])
        (dict ["name" "find_all existing elements"] ["input" [[1 2 3 2 4 2] 2]] ["want" [1 3 5]])
        (dict ["name" "find_all non-existing elements"] ["input" [[1 2 3 4] 5]] ["want" []])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let arr (get (get test "input") 0))
        (let n (get (get test "input") 1))
        (let want (get test "want"))
        (let got (list:find_all arr n))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn test_list_sort []
    (let tests [
        (dict ["name" "sort null"] ["input" null] ["want" null])
        (dict ["name" "sort empty list"] ["input" []] ["want" []])
        (dict ["name" "sort single element"] ["input" [1]] ["want" [1]])
        (dict ["name" "sort multiple elements"] ["input" [4 2 5 1 3]] ["want" [1 2 3 4 5]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (list:sort input))
        (assert:list_equal got want)
        (println ": OK")
    ))
))

((fn benchmark_list_sort []
    (print "Benchmarking list:sort ... ")
    (let vec (_mk_rand_vec 1000))
    (test_utils:benchmark (fn [] (
        (list:sort vec)
    )))
    (println "OK")
))

((fn benchmarh_list_quicksort []
    (print "Benchmarking list:quicksort ... ")
    (let vec (_mk_rand_vec 1000))
    (test_utils:benchmark (fn [] (
        (list:quicksort vec)
    )))
    (println "OK")
))

((fn benchmarh_list_mergesort []
    (print "Benchmarking list:mergesort ...")
    (let vec (_mk_rand_vec 1000))
    (test_utils:benchmark (fn [] (
        (list:mergesort vec)
    )))
    (println "OK")
))

((fn benchmark_list_find []
    (print "Benchmarking list:find ... ")
    (let vec (_mk_rand_vec 1000))
    (let n (get vec 500))
    (test_utils:benchmark (fn [] (
        (list:find vec n)
    )))
    (println "OK")
))

((fn benchmark_list_find_all []
    (print "Benchmarking list:find_all ... ")
    (let vec (_mk_rand_vec 1000))
    (let n (get vec 500))
    (test_utils:benchmark (fn [] (
        (list:find_all vec n)
    )))
    (println "OK")
))
