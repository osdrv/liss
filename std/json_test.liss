(import "assert")
(import "json")
(import "list" ["map"])

((fn test_json_parse []
    (let tests [
        (dict ["name" "json:parse null value"] ["input" "null"] ["want" null])
        (dict ["name" "json:parse boolean true"] ["input" "true"] ["want" true])
        (dict ["name" "json:parse boolean false"] ["input" "false"] ["want" false])
        (dict ["name" "json:parse simple string"] ["input" "\"hello\""] ["want" "hello"])
        (dict ["name" "json:parse simple integer number"] ["input" "123"] ["want" 123])
        (dict ["name" "json:parse simple float number"] ["input" "3.14"] ["want" 3.14])
        (dict ["name" "json:parse negative integer"] ["input" "-42"] ["want" -42])
        (dict ["name" "json:parse negative float"] ["input" "-0.001"] ["want" -0.001])
        (dict ["name" "json:parse array with various primitives"]
              ["input" "[null, \"foo\", 123, 456.789, true, false]"]
              ["want" [null "foo" 123 456.789 true false]]
        )
        (dict ["name" "json:parse object with various keys"]
              ["input" "{\"foo\": \"bar\", 123: 456, true: false, -1.23: 4.56}"]
              ["want" (dict ["foo" "bar"] [123 456] [true false] [-1.23 4.56])]
        )
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (json:parse input))
        (assert:deep_equal got want)
        (println ": OK")
    ))
))

((fn test_json_encode []
    (let tests [
        (dict ["name" "json:encode null value"] ["input" null] ["want" "null"])
        (dict ["name" "json:encode boolean true"] ["input" true] ["want" "true"])
        (dict ["name" "json:encode boolean false"] ["input" false] ["want" "false"])
        (dict ["name" "json:encode simple string"] ["input" "hello"] ["want" "\"hello\""])
        (dict ["name" "json:encode simple integer number"] ["input" 123] ["want" "123"])
        (dict ["name" "json:encode simple float number"] ["input" 3.14] ["want" "3.14"])
        (dict ["name" "json:encode negative integer"] ["input" -42] ["want" "-42"])
        (dict ["name" "json:encode negative float"] ["input" -0.001] ["want" "-0.001"])
        (dict ["name" "json:encode array with various primitives"]
              ["input" [null "foo" 123 456.789 true false]]
              ["want" "[null,\"foo\",123,456.789,true,false]"]
        )
        (dict ["name" "json:encode object with various keys"]
              ["input" (dict ["foo" "bar"] [123 456] [true false] [-1.23 4.56])]
              ["want" "{\"-1.23\":4.56,\"123\":456,\"foo\":\"bar\",\"true\":false}"]
              ["verifyFn" (fn [got want]
                  (assert:dict_equal (json:parse got) (json:parse want))
              )]
        )
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let want (get test "want"))
        (let got (json:encode input))
        (let verifyFn (get test "verifyFn"))
        (cond (not (is_null? verifyFn))
            (verifyFn got want)
            (assert:equal got want)
        )
        (println ": OK")
    ))
))
