(import "assert" ["equal"])
(import "list" ["map"])
(import "strings")
(import "test_utils" ["benchmark"])

((fn test []
    (let _match_all_res (test_utils:benchmark (fn []
        (strings:match_all
            ".*mul\\((\\d+),(\\d+)\\).*"
            "xmul(2,4)%&mul[3,7]!@^do_not_mul(5,5)+mul(32,64]then(mul(11,8)mul(8,5))"
        )
    )))
    (println "Test match_all result: " _match_all_res)

    (fn test_reverse []
        (let s "Hello, World!")
        (let reversed (strings:reverse s))
        (println "Original string: " s)
        (println "Reversed string: " reversed)
    )
    (test_reverse)
))

((fn test_strings_join []
    (let tests [
        (dict ["name" "join null"] ["input" null] ["delim" ", "] ["want" null])
        (dict ["name" "join empty list"] ["input" []] ["delim" ", "] ["want" ""])
        (dict ["name" "join single element"] ["input" ["Hello"]] ["delim" ", "] ["want" "Hello"])
        (dict ["name" "join multiple elements"] ["input" ["Hello" "World" "from" "Liss"]] ["delim" " "] ["want" "Hello World from Liss"])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let input (get test "input"))
        (let delim (get test "delim"))
        (let want (get test "want"))
        (let got (strings:join input delim))
        (assert:equal got want)
        (println ": OK")
    ))
))

((fn test_strings_match_all []
    (let tests [
        (dict ["name" "match_all no matches"] ["pattern" "a(bc)d"] ["s" "xyzxyzxyz"] ["want" []])
        (dict ["name" "match_all single match"] ["pattern" "a(bc)d"] ["s" "xyzabcdxyz"] ["want" [["abcd" "bc"]]])
        ; TODO: these tests are failing because my implementation is faulty
        ;(dict ["name" "match_all multiple matches"] ["pattern" "a(bc)d"] ["s" "abcdxyzabcd123abcd"] ["want" [["abcd" "bc"] ["abcd" "bc"] ["abcd" "bc"]]])
        ;(dict ["name" "match_all overlapping matches"] ["pattern" "(\\d\\d)"] ["s" "12345"] ["want" [["12"] ["23"] ["34"] ["45"]]])
    ])
    (list:map tests (fn [test]
        (print "Running test: " (get test "name"))
        (let pattern (get test "pattern"))
        (let s (get test "s"))
        (let want (get test "want"))
        (let got (strings:match_all pattern s))
        (assert:list_equal got want)
        (println ": OK")
    ))
))
